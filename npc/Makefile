# Configurations
BUILD_DIR = ./build
VSRC_DIR ?= ./vsrc
CSRC_DIR = ./csrc
MAIN_NAME = PS2Shower

# Include variables and rules generated by menuconfig
-include $(NPC_HOME)/include/config/auto.conf
-include $(NPC_HOME)/include/config/auto.conf.cmd
Kconfig := $(NPC_HOME)/Kconfig
export KCONFIG_AUTOHEADER := $(NPC_HOME)/include/npc/generated/autoconf.h
export KCONFIG_AUTOCONFIG := $(NPC_HOME)/include/config/auto.conf
-include $(NEMU_HOME)/scripts/config.mk

VSRC = $(shell find $(VSRC_DIR) -type f -name "*.sv")
CSRC = $(shell find $(CSRC_DIR) -type f -name "*.cpp")
CXX_INC += -I$(NVBOARD_HOME)/include
CXX_INC += -I$(NPC_HOME)/include
CXX_INC += -I$(NEMU_HOME)/include
LD_LIBS += -lfmt $(if $(CONFIG_NVBOARD_ENABLE), -lSDL2 -lSDL2_image)
VXX_FLAGS = --trace-fst -CFLAGS "-g $(CXX_INC) -D__$(MAIN_NAME)_MAIN__" -LDFLAGS "$(LD_LIBS)" -Mdir $(BUILD_DIR)
SIM_ELF = $(BUILD_DIR)/Vtop
NVBOARD_BIND = $(BUILD_DIR)/auto_bind.cpp
NVBOARD_DEP = $(if $(CONFIG_NVBOARD_ENABLE), $(NVBOARD_ARCHIVE) $(NVBOARD_BIND),)
CHISEL_VERSION ?= chisel3

ifeq ($(CHISEL_VERSION), chisel3)
FIRTOOL_VERSION := 1.37.2
else
FIRTOOL_VERSION := 1.62.0
endif
FIRTOOL_URL = https://github.com/llvm/circt/releases/download/firtool-$(FIRTOOL_VERSION)/firrtl-bin-linux-x64.tar.gz
FIRTOOL_PATH = $(shell which firtool 2>/dev/null)
CACHE_FIRTOOL_PATH = $(HOME)/.cache/xiangshan/firtool-$(FIRTOOL_VERSION)/bin/firtool
ifeq ($(MFC),1)
ifeq ($(FIRTOOL_PATH),)
ifeq ($(wildcard $(CACHE_FIRTOOL_PATH)),)
$(info [INFO] Firtool not found in your PATH.)
$(info [INFO] Downloading from $(FIRTOOL_URL))
$(shell mkdir -p $(HOME)/.cache/xiangshan && curl -L $(FIRTOOL_URL) | tar -xzC $(HOME)/.cache/xiangshan)
endif
FIRTOOL_ARGS = --firtool-binary-path $(CACHE_FIRTOOL_PATH)
endif
endif
export PATH := $(abspath .cache/firtool-$(FIRTOOL_VERSION)/bin):$(PATH)

init:
	git clone https://github.com/OpenXiangShan/rocket-chip.git
	git clone https://github.com/OpenXiangShan/Utility utility
	cd rocket-chip && git submodule update --init cde hardfloat

test:
	mill -i playground[chisel3].test

verilog:
	$(call git_commit, "generate verilog")
	mkdir -p $(BUILD_DIR)
	mill -i playground.runMain Elaborate -td $(BUILD_DIR)

sim-verilog:
	mill -i playground[$(CHISEL_VERSION)].runMain Elaborate -td $(BUILD_DIR)

npcHelp:
	mill -i __.test.runMain Elaborate --help

compile:
	mill -i __.compile

bsp:
	mill -i mill.bsp.BSP/install

reformat:
	mill -i __.reformat

checkformat:
	mill -i __.checkFormat

clean:
	-rm -rf $(BUILD_DIR)

.PHONY: test verilog help compile bsp reformat checkformat clean

onOff:
	mkdir -p $(BUILD_DIR)
	cp $(VSRC_DIR)/OnOffSwitch/top.sv $(BUILD_DIR)/top.sv

vheadc:
	verilator $(VXX_FLAGS) --cc $(BUILD_DIR)/top.sv

$(SIM_ELF): $(CSRC) $(NVBOARD_DEP) $(BUILD_DIR)/top.sv
	$(call git_commit, "sim RTL") # DO NOT REMOVE THIS LINE!!!
	verilator $(VXX_FLAGS) --cc $(BUILD_DIR)/top.sv --exe $(CSRC) $(NVBOARD_DEP) --build

elf: $(SIM_ELF)

sim: $(SIM_ELF)
	$(SIM_ELF)

-include ../Makefile
-include $(NVBOARD_HOME)/scripts/nvboard.mk
$(NVBOARD_BIND): constr/$(MAIN_NAME).nxdc
	mkdir -p $(BUILD_DIR)
	python $(NVBOARD_HOME)/scripts/auto_pin_bind.py $^ $@
